<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <span th:replace="com/head :: head"></span>
    <title >index</title>
    <link rel="stylesheet" th:href="@{/item/jsmind/style/jsmind.css}">
    <link rel="stylesheet" th:href="@{/item/highlight/styles/monokai-sublime.css}">
    <script type="text/javascript" th:src="@{/item/marked-master/marked.min.js}"></script>
    <script type="text/javascript" th:src="@{/item/highlight/highlight.pack.js}"></script>
    <script type="text/javascript" th:src="@{/item/jsmind/js/jsmind.js}"></script>
    <script type="text/javascript" th:src="@{/item/jsmind/js/jsmind.draggable.js}"></script>
    <script type="text/javascript" th:src="@{/item/jsmind/features/jsmind.shell.js}"></script>
    <style type="text/css">
        table{
            border: 1px solid skyblue;
            border-collapse:collapse;
        }
        thead{
            color: #0C9A9A;
        }
        th{
            border: 1px solid skyblue;
        }
        td{
            border: 1px solid skyblue;
        }
        blockquote{
            border-left: 1px solid skyblue;
        }
        #jsmind_container{
            height: 1000px;
        }
        #mind_container{
            height: 1000px;
        }
        .right_bar{
            position: fixed !important;
            z-index: 10 !important;
            bottom: 0 !important;
            right: 0 !important;
            padding: 0.8em !important;
        }
    </style>
</head>
<body>
    <div id="app">
        <input type="number" hidden="hidden" id="nodeId" th:value="${nodeId}">
        <div th:replace="com/menu :: iteratorMenu"></div>
        <div id="top"></div>
        <br><br><br>
        <div class="ui fluid container" v-show="isNode">
            <div class="ui container" style="width: 85%;">
                <div class="ui piled segment" v-show="isBlog">
                    <textarea hidden="hidden" th:text="${html}" id="html" style="white-space: pre-line"></textarea>
                    <div id="content"></div>
                    <span th:if="${flag}">
                                <br><br><br><br><br><br><br><br><br><br>
                                <br><br><br><br><br><br><br><br><br><br>
                                <br><br><br><br><br><br><br><br><br><br>
                                <br><br><br><br><br><br><br><br><br><br>
                                <br><br><br><br><br><br><br><br><br><br>
                            </span>
                </div>
                <div class="ui raised segment" v-show="!isBlog">
                    <div id="jsmind_container"></div>
                </div>
            </div>
        </div>
        <div class="ui container" v-show="!isNode" style="width: 80%;">
            <div class="ui stacked segment">
                <div id="mind_container"></div>
            </div>
        </div>
        <br><br>
        <div th:replace="com/foot :: foot"></div>
        <div th:replace="com/Bar :: right_bar"></div>
    </div>

    <script type="text/javascript">

        let app = new Vue({
            el: '#app',
            data: {
                isBlog: true,
                isNode: true,
                isLogin: false,
                str: '',
                html: '',
                nodeId: 0,
                userVo: {}
            },
            mounted: function(){
                let nodeId = document.getElementById('nodeId').value
                this.nodeId = nodeId
                axios.get("/user/getUserInfo")
                    .then(response => {
                        if (response.data !== ""){
                            this.isLogin = true
                            this.userVo = response.data
                        }else{
                            this.isLogin = false
                        }
                    })
                    .catch(error => console.log(error))

                axios.get("/public/getMind?nodeId=" + nodeId)
                    .then(response => {
                        let options = {
                            mode: 'full',
                            container: 'jsmind_container',
                            editable: true,
                            theme:'orange',
                            support_html: true,
                            view:{
                                engine: 'canvas',   // 思维导图各节点之间线条的绘制引擎
                                hmargin:100,        // 思维导图距容器外框的最小水平距离
                                vmargin:200,         // 思维导图距容器外框的最小垂直距离
                                line_width:3,       // 思维导图线条的粗细
                                line_color:'#555'   // 思维导图线条的颜色
                            },
                            layout:{
                                hspace:100,          // 节点之间的水平间距
                                vspace:200,          // 节点之间的垂直间距
                                pspace:2           // 节点与连接线之间的水平间距（用于容纳节点收缩/展开控制器）
                            },
                        }
                        let m = response.data
                        let res = []
                        m.forEach((item) =>{
                            let obj = {}
                            obj.id = item.id
                            obj.parentid = item.parentid
                            obj.isroot = item.isroot
                            obj.topic = item.topic
                            obj.direction = item.direction
                            obj.expanded = item.expanded
                            res.push(obj)
                        })
                        let mind = {
                            "meta":{
                                "name":"测试",
                                "author":"xiaobai",
                                "version":"1.0",
                            },
                            "format":"node_array",
                            "data": res
                        }
                        let jm = new jsMind(options)
                        jm.show(mind)
                    })
                    .catch(error => console.log(error))

                axios.get('/person/public/getIteratorMind?nodeId=' + nodeId)
                    .then(response => {
                        let options = {
                            mode: 'full',
                            container: 'mind_container',
                            editable: true,
                            theme:'orange',
                            support_html: true,
                            view:{
                                engine: 'canvas',   // 思维导图各节点之间线条的绘制引擎
                                hmargin:50,        // 思维导图距容器外框的最小水平距离
                                vmargin:50,         // 思维导图距容器外框的最小垂直距离
                                line_width:3,       // 思维导图线条的粗细
                                line_color:'#555'   // 思维导图线条的颜色
                            },
                            layout:{
                                hspace:400,          // 节点之间的水平间距
                                vspace:200,          // 节点之间的垂直间距
                                pspace:2           // 节点与连接线之间的水平间距（用于容纳节点收缩/展开控制器）
                            },
                        }
                        let m = response.data
                        let res = []
                        m.forEach((item) =>{
                            let obj = {}
                            obj.id = item.id
                            obj.parentid = item.parentid
                            obj.isroot = item.isroot
                            obj.topic = item.topic
                            obj.direction = item.direction
                            obj.expanded = item.expanded
                            res.push(obj)
                        })
                        let mind = {
                            "meta":{
                                "name":"测试",
                                "author":"xiaobai",
                                "version":"1.0",
                            },
                            "format":"node_array",
                            "data": res
                        }
                        let jm = new jsMind(options)
                        jm.show(mind)
                    })
                    .catch(error => console.log(error))

            },
            methods: {
                changeBlog: function() {
                    this.isBlog = !this.isBlog
                },
                changeNode: function() {
                    this.isNode = !this.isNode
                },
                logout: function() {
                    this.isLogin = false
                },
                search: function() {
                    if (this.str === "") {
                        alert("请输入搜索内容")
                    } else {
                        console.log(this.str)
                    }
                },
                toTop: function(){
                    window.location.href = '#top'
                }
            },
        })

        let html = document.getElementById('html').value;
        app.html = html;
        document.getElementById('content').innerHTML = marked(html
            , {
                baseUrl: null,
                breaks: true,
                gfm: true,
                headerIds: true,
                headerPrefix: '',
                highlight: function(code, language){
                    const validLanguage = hljs.getLanguage(language) ? language : 'plaintext';
                    return hljs.highlight(validLanguage, code).value;
                },
                langPrefix: 'language-',
                mangle: true,
                pedantic: false,
                renderer: new marked.Renderer(),
                silent: false,
                smartLists: true,
                smartypants: true,
                xhtml: true
            });
        hljs.initHighlightingOnLoad()
    </script>
</body>
</html>